<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="tribuna.content">

<body>

<metal:block fill-slot="style_slot">
    <link rel="stylesheet" type="text/css"
            tal:define="navroot context/@@plone_portal_state/navigation_root_url"
            tal:attributes="href string:${navroot}/++resource++tribuna.diazotheme/css/jquery-ui-1.10.3.custom.min.css"
            />
        <script type="text/javascript"
            tal:define="navroot context/@@plone_portal_state/navigation_root_url"
            tal:attributes="src string:${navroot}/++resource++tribuna.diazotheme/js/jquery-ui-1.10.3.custom.min.js"
            ></script>
        <link rel="stylesheet" type="text/css"
            tal:define="navroot context/@@plone_portal_state/navigation_root_url"
            tal:attributes="href string:${navroot}/++resource++tribuna.diazotheme/css/jquery.galleryview-3.0.css"
            />
        <script type="text/javascript"
            tal:define="navroot context/@@plone_portal_state/navigation_root_url"
            tal:attributes="src string:${navroot}/++resource++tribuna.diazotheme/js/jquery.galleryview-3.0.min.js"
            ></script>
        <script type="text/javascript"
            tal:define="navroot context/@@plone_portal_state/navigation_root_url"
            tal:attributes="src string:${navroot}/++resource++tribuna.diazotheme/js/jquery.easing.1.3.js"
            ></script>
        <script type="text/javascript"
            tal:define="navroot context/@@plone_portal_state/navigation_root_url"
            tal:attributes="src string:${navroot}/++resource++tribuna.diazotheme/js/jquery.timers-1.2.js"
            ></script>
</metal:block>
<metal:main fill-slot="main">
    <tal:main-macro metal:define-macro="main">


<!--         <tal:block tal:replace="view/checkGET" /> -->
        <div tal:replace="structure provider:plone.abovecontenttitle" />

        <h1 class="documentFirstHeading"> Home page </h1>


        <div tal:replace="structure provider:plone.belowcontenttitle" />


        <div tal:replace="structure provider:plone.abovecontentbody" />

        <tal:block
            tal:define="has_one_tag view/only_one_tag;
                        homepageClass python: has_one_tag and 'span3' or 'span10';
                        hasOneTagClassAddition python: has_one_tag and '-one' or ''">
          <div id="tag-description-div" tal:condition="has_one_tag">
            <h2 i18n:translate="">Description</h2>
            ${view/tag_description}
          </div>
          <div id="homepage-div" class="${homepageClass}">
            <h2 i18n:translate="" tal:condition="view/is_text_view">Articles</h2>

           <tal:block tal:condition="view/is_text_view">

              <div class="articles_intersection">
                <h5 i18n:translate="" tal:condition="view/show_intersection">Intersection</h5>
                <tal:block repeat="article view/articles_intersection">
                    <div id="${article/UID}"
                         tal:define="isArticle python: article.portal_type == 'tribuna.content.article';
                                     isComment python: article.portal_type == 'Discussion Item';
                                     typeClassAddition python: isArticle and 'article' or 'comment'"
                         class="ui-widget-content text-view text-view-${typeClassAddition}${hasOneTagClassAddition}"
                    >
                        <div id="gallery-link">

                          <a tal:condition="isArticle" href="${context/absolute_url}/@@main-page?article=${article/id}" tal:content="article/title" />
                          <a tal:condition="isComment" class="text-view" href="${context/absolute_url}/@@main-page?article=${article/id}" tal:content="structure article/getText" />

                        </div>
                     <p tal:condition="isArticle" class="text-view" tal:content="article/description" />
                     <p i18n:translate="" tal:condition="isArticle" class="content-type" style="color: red">article</p>
                     <p i18n:translate="" tal:condition="isComment" class="content-type" style="color: red">comment</p>
                 </div>
                </tal:block>
              </div>

              <div class="articles_union">
                <h5 i18n:translate="" tal:condition="view/show_union">Union</h5>
                <tal:block repeat="article view/articles_union">
                    <div id="${article/UID}"
                         tal:define="isArticle python: article.portal_type == 'tribuna.content.article';
                                     isComment python: article.portal_type == 'Discussion Item';
                                     typeClassAddition python: isArticle and 'article' or 'comment'"
                         class="ui-widget-content text-view text-view-${typeClassAddition}${hasOneTagClassAddition}"
                    >
                      <div id="gallery-link">

                        <a tal:condition="isArticle" href="${context/absolute_url}/@@main-page?article=${article/id}" tal:content="article/title" />
                        <a tal:condition="isComment" class="text-view" href="${context/absolute_url}/@@main-page?article=${article/id}" tal:content="structure article/getText" />
                      </div>
                    <p tal:condition="isArticle" class="text-view" tal:content="article/description" />
                    <p i18n:translate="" tal:condition="isArticle" class="content-type" style="color: red">article</p>
                    <p i18n:translate="" tal:condition="isComment" class="content-type" style="color: red">comment</p>

                    </div>
                </tal:block>
              </div>
          </tal:block>
          <tal:block tal:condition="not: view/is_text_view">
              <tal:block repeat="article view/articles_all">
                <tal:block tal:define="isArticle python: article.portal_type == 'tribuna.content.article';
                                       isComment python: article.portal_type == 'Discussion Item';
                                       addedClass python: isArticle and 'article' or 'comment';
                                       varUID   python: isComment and article.getId() or article.UID()"
                >
                  <div id="${varUID}" class="ui-widget-content drag-view-${addedClass}">
                    <img tal:condition="isArticle" tal:attributes="src string:${article/absolute_url}/@@images/image/preview" />
                    <div id="text">
                      <div id="gallery-link">
                        <a href="${context/absolute_url}/@@main-page?article=${article/id}" tal:content="article/title" />
                        <a tal:condition="isComment" class="text-view" href="${context/absolute_url}/@@main-page?article=${article/id}" tal:content="structure article/getText" />
                      </div>
                      <p tal:condition="isArticle" class="drag-view" tal:content="article/description" />
                      <div id="drag-view-extras">
                        <p i18n:translate="" tal:condition="isArticle" class="content-type" style="color: red">article</p>
                        <p i18n:translate="" tal:condition="isComment" class="content-type" style="color: red">comment</p>
                      </div>
                    </div>
                  </div>

                  <script>
                      $(function() {
                          var articleUID = "#${varUID}";
                          $(articleUID).css({'position' : 'absolute'});
                          // $(articleUID).draggable({containment: "parent", stack: "div", cancel: "h3" });
                          $(articleUID).draggable({stack: "div", cancel: "a" });
                          $(articleUID).draggable("option", "distance", 0 );

                          // Add the current height and width (defined by img) to the style, so the div doesn't shrink on hover. Need to add this on img.load, so it can always find the information
                          if("${isArticle}"){
                            var image = $(articleUID).find('img');
                            image.load(function(){
                                var imageHeight = $(this).height();
                                var imageWidth = $(this).width();
                                var numRandx = Math.floor(Math.random() * ($('#homepage-div').width() - imageWidth));
                                var numRandy = Math.floor(Math.random() * ($('#homepage-div').height() - imageHeight));

                                if(numRandx < 0) {
                                  numRandx = 0;
                                }
                                if(numRandy < 0) {
                                  numRandy = 0;
                                }

                                var article = $(articleUID);
                                article.css({'height': imageHeight});
                                article.css({'width': imageWidth});
                                article.css({'left': numRandx});
                                article.css({'top': numRandy});
                            });
                            image.one('load', function() {
                            }).each(function() {
                              if(this.complete) $(this).load();
                            });
                          }
                          else{
                            // Set the width so it doesn't get squished if we go over the border
                            var numRandx = Math.floor(Math.random() * ($('#homepage-div').width() - $(articleUID).width()));
                            var numRandy = Math.floor(Math.random() * ($('#homepage-div').height() - $(articleUID).height()));

                            if(numRandx < 0) {
                              numRandx = 0;
                            }
                            if(numRandy < 0) {
                              numRandy = 0;
                            }

                            var article = $(articleUID);
                            article.css({'width': article.width()});
                            article.css({'left': numRandx});
                            article.css({'top': numRandy});
                          }
                      });
                </script>
              </tal:block>
          </tal:block>
          </div>
        </tal:block>
        <div tal:replace="structure provider:plone.belowcontentbody" />
    </tal:main-macro>
</metal:main>


</body>
</html>
