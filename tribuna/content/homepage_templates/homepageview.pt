<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="tribuna.content">

<body>

  <metal:block fill-slot="style_slot">
  <link rel="stylesheet" type="text/css"
        tal:define="navroot context/@@plone_portal_state/navigation_root_url"
        tal:attributes="href string:${navroot}/++resource++tribuna.diazotheme/css/jquery-ui-1.10.3.custom.min.css"/>
  <script type="text/javascript"
          tal:define="navroot context/@@plone_portal_state/navigation_root_url"
          tal:attributes="src string:${navroot}/++resource++tribuna.diazotheme/js/jquery-ui-1.10.3.custom.min.js">
  </script>
  <link rel="stylesheet" type="text/css"
        tal:define="navroot context/@@plone_portal_state/navigation_root_url"
        tal:attributes="href string:${navroot}/++resource++tribuna.diazotheme/css/jquery.galleryview-3.0.css"/>
  <script type="text/javascript"
          tal:define="navroot context/@@plone_portal_state/navigation_root_url"
          tal:attributes="src string:${navroot}/++resource++tribuna.diazotheme/js/jquery.galleryview-3.0.min.js">
  </script>
  <script type="text/javascript"
          tal:define="navroot context/@@plone_portal_state/navigation_root_url"
          tal:attributes="src string:${navroot}/++resource++tribuna.diazotheme/js/jquery.easing.1.3.js">
  </script>
  <script type="text/javascript"
          tal:define="navroot context/@@plone_portal_state/navigation_root_url"
          tal:attributes="src string:${navroot}/++resource++tribuna.diazotheme/js/jquery.timers-1.2.js">
  </script>
  <script type="text/javascript">
        $(document).ready(function() {
          vpw = window.innerWidth;
          vph = window.innerHeight;
          $("#tag-picture img").css({"height": vph-100});
          $('#scroll').click(function() {
                $('html, body').animate({
                     scrollTop: $("#container").offset().top
                 }, 500);
            })

        });
  </script>
</metal:block>

<metal:main fill-slot="main">
<tal:main-macro metal:define-macro="main">

  <div tal:replace="structure provider:plone.abovecontenttitle" />
  <h1 class="documentFirstHeading">Home page</h1>
  <div tal:replace="structure provider:plone.belowcontenttitle" />
  <div tal:replace="structure provider:plone.abovecontentbody" />

  <div id="search-form">
      <form id="searchForm" name="searchForm" method="post" action="@@search">
        <div class="LSBox">
          <input type="text" id="searchGadget" class="searchField" placeholder="Search.." title="Search" name="SearchableText" autocomplete="off">
          <div class="LSResult bordered" id="LSResult" style="display:none;">
            <div class="LSShadow" id="LSShadow"></div>
          </div>
        </div>
      </form>
  </div>
  <div id="search-view" tal:condition="view/is_search_view" style="display:none"></div>

  <tal:block tal:define="has_one_tag view/only_one_tag;
                         hasOneTagClassAddition python: has_one_tag and '-one' or '';
                         articles view/articles">

    <div id="tag-picture" tal:condition="has_one_tag">
      <img tal:condition="view/tag_picture"  src="${view/tag_picture}"/>
      <div tal:condition="view/tag_picture" id="scroll"/>
    </div>
    <div id="tag-description-div" tal:condition="has_one_tag">
      <h2 i18n:translate="">Description</h2>
      ${view/tag_description}
    </div>

    <div id="homepage-div"
         tal:define="articles_num python: len(articles['all'])">
      <h2 id="empty-results"
          tal:condition="python: not articles['all'] or articles_num == 0"
          i18n:translate="">
        No results!
      </h2>

      <tal:block tal:condition="python: view.is_text_view() and articles['all'] or articles_num == 0">

        <h2 i18n:translate="">Articles</h2>

        <span id="results-num">
          <tal:block tal:content="articles_num">num</tal:block>
          <tal:block i18n:translate="">results</tal:block>
        </span>

        <div class="articles-intersection">
          <h5 i18n:translate=""
              tal:condition="python: view.show_intersection() and view.tags_selected()">Intersection</h5>
          <tal:block repeat="article python: articles['intersection']">
            <tal:block tal:define="isArticle python: article.portal_type == 'tribuna.content.article';
                                   isComment python: article.portal_type == 'Discussion Item';
                                   typeClassAddition python: isArticle and 'article' or 'comment';
                                   varUID python: isComment and article.getId() or article.UID()">
              <div id="${varUID}"
                   class="ui-widget-content text-view text-view-${typeClassAddition}${hasOneTagClassAddition}">
                <div id="gallery-link">
                  <a tal:condition="isArticle"
                     class="article-header"
                     href="${context/absolute_url}/@@articles/${article/id}"
                     tal:content="article/title" />
                  <a tal:condition="isComment"
                     class="comment-header"
                     href="${context/absolute_url}/@@articles/${article/id}"
                     tal:content="structure python: view.shorten_text(article.getText())" />
                </div>
                <p tal:condition="isArticle" class="article-body" tal:content="article/description" />
                <p i18n:translate="" tal:condition="isArticle" class="content-type">
                  <span class="red" i18n:translate="">article</span>
                </p>
                <p i18n:translate="" tal:condition="isComment" class="content-type">
                  <span class="red" i18n:translate="">comment</span>
                </p>
              </div>
            </tal:block>
          </tal:block>
        </div>

        <div class="articles-union">
          <h5 i18n:translate="" tal:condition="python: view.show_intersection() and view.tags_selected()">Union</h5>
          <tal:block repeat="article python: articles['union']">
            <tal:block tal:define="isArticle python: article.portal_type == 'tribuna.content.article';
                                   isComment python: article.portal_type == 'Discussion Item';
                                   typeClassAddition python: isArticle and 'article' or 'comment';
                                   varUID python: isComment and article.getId() or article.UID()">
              <div id="${varUID}"
                   class="ui-widget-content text-view text-view-${typeClassAddition}${hasOneTagClassAddition}">
                <div id="gallery-link">
                  <a tal:condition="isArticle"
                     class="article-header"
                     href="${context/absolute_url}/@@articles/${article/id}"
                     tal:content="article/title" />
                  <a tal:condition="isComment"
                     class="comment-header"
                     href="${context/absolute_url}/@@articles/${article/id}"
                     tal:content="structure python: view.shorten_text(article.getText())" />
                </div>
                <p tal:condition="isArticle" class="article-body" tal:content="article/description" />
                <p i18n:translate="" tal:condition="isArticle" class="content-type">
                  <span class="red" i18n:translate="">article</span>
                </p>
                <p i18n:translate="" tal:condition="isComment" class="content-type">
                  <span class="red" i18n:translate="">comment</span>
                </p>
              </div>
            </tal:block>
          </tal:block>
        </div>
      </tal:block>

      <tal:block tal:condition="python: not view.is_text_view()">
        <tal:block repeat="article python: articles['all']">
          <tal:block tal:define="isArticle python: article.portal_type == 'tribuna.content.article';
                                 isComment python: article.portal_type == 'Discussion Item';
                                 typeClassAddition python: isArticle and 'article' or 'comment';
                                 varUID python: isComment and article.getId() or article.UID()">
            <div id="${varUID}" class="ui-widget-content drag-view-${typeClassAddition}">
              <img tal:condition="isArticle"
                   tal:attributes="src string:${article/absolute_url}/@@images/image/preview" />
              <div id="text">
                <div id="gallery-link">
                  <a tal:condition="isArticle"
                     class="article-header"
                     href="${context/absolute_url}/@@articles/${article/id}"
                     tal:content="article/title" />
                  <a tal:condition="isComment"
                     class="drag-comment-header"
                     href="${context/absolute_url}/@@articles/${article/id}"
                     tal:content="structure python: view.shorten_text(article.getText())" />
                </div>
                <div id="drag-view-type">
                  <p i18n:translate="" tal:condition="isArticle" class="content-type">
                    <span class="red" i18n:translate="">article</span>
                  </p>
                  <p i18n:translate="" tal:condition="isComment" class="content-type">
                    <span class="red" i18n:translate="">comment</span>
                  </p>
                </div>
                <div id="drag-view-tags">
                  <span id="drag-view-tags-list">
                    <tal:block tal:condition="isArticle">
                      <tal:block tal:define="varTagList python: ', '.join(article.Subject())">${varTagList}</tal:block>
                    </tal:block>
                  </span>
                </div>
                <p tal:condition="isArticle" class="article-body" tal:content="article/description" />
              </div>
            </div>

            <script>
              $(function() {
                  var articleUID = "#${varUID}";
                  $(articleUID).css({'position' : 'absolute'});
                  // $(articleUID).draggable({containment: "parent", stack: "div", cancel: "h3" });
                  $(articleUID).draggable({stack: "div", cancel: "a" });
                  $(articleUID).draggable("option", "distance", 0 );

                  // Add the current height and width (defined by img) to the style, so the div doesn't shrink on hover. Need to add this on img.load, so it can always find the information
                  if("${isArticle}" === "True"){
                    // console.info("Article");
                    var image = $(articleUID).find('img');
                    image.load(function(){
                        var imageHeight = $(this).height();
                        var imageWidth = $(this).width();
                        var numRandx = Math.floor(Math.random() * ($('#homepage-div').width() - imageWidth));
                        var numRandy = Math.floor(Math.random() * ($('#homepage-div').height() - imageHeight));

                        if(numRandx < 0) {
                          numRandx = 0;
                        }
                        if(numRandy < 0) {
                          numRandy = 0;
                        }

                        var article = $(articleUID);
                        article.css({'height': imageHeight});
                        article.css({'width': imageWidth});
                        article.css({'left': numRandx});
                        article.css({'top': numRandy});
                    });
                    image.one('load', function() {
                    }).each(function() {
                      if(this.complete) $(this).load();
                    });
                  }
                  else{
                    // console.info("Other");
                    // Set the width so it doesn't get squished if we go over the border
                    var numRandx = Math.floor(Math.random() * ($('#homepage-div').width() - $(articleUID).width()));
                    var numRandy = Math.floor(Math.random() * ($('#homepage-div').height() - $(articleUID).height()));

                    if(numRandx < 0) {
                      numRandx = 0;
                    }
                    if(numRandy < 0) {
                      numRandy = 0;
                    }

                    var article = $(articleUID);
                    article.css({'width': article.width()});
                    article.css({'left': numRandx});
                    article.css({'top': numRandy});
                    article.css({"min-width": "100px"});
                  }
              });
            </script>
          </tal:block>
        </tal:block>
      </tal:block>
      </div>
    </tal:block>
    <div tal:replace="structure provider:plone.belowcontentbody" />
  </tal:main-macro>
</metal:main>

</body>
</html>
